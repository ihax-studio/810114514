<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>ホモタッチ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="114514.css">
<link rel="apple-touch-icon" sizes="180x180" href="icon-191.png">
<!-- 複数サイズ用意するなら（優先度高いものが先） -->
<link rel="apple-touch-icon" sizes="192x192" href="icon-191.png">
<link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
<link rel="manifest" href="manifest.json">
<script src="sw.js"></script>
<meta name="theme-color" content="#fff">
<link rel="icon" type="image/png" sizes="192x192" href="icon-191.png">
<link rel="icon" type="image/png" sizes="32x32" href="icon-191.png">
<link rel="shortcut icon" href="icon-191.png">
</head>
<body oncontextmenu="return false;">
    <div id="title-bar">
        <div id="main-title">野獣ゲーム</div>
    </div>
    <div id="welcome">
        <div id="welcome-card">
            <div class="desc">
                <h2>ホモタッチ</h2>
                流れてイクブロックを<br>
                正しいタイミングでタップだゾ。<hr>
            </div>
            <div class="setting-row">
                <div class="setting-label">横のマス</div>
                <input id="colInput" class="setting-input" type="number" min="2" max="10" value="3">
            </div>
            <div class="setting-row">
                <div class="setting-label">鳴き声</div>
                <select id="soundSelect" class="sound-select"></select>
                <span id="soundCheck" class="sound-check"></span>
            </div>
            <div class="setting-row timing-row">
                <label class="ios-toggle-wrap">
                      <span class="timing-easy-label">タイミング掴みやすく</span>
                    <span class="ios-toggle">
                        <input type="checkbox" id="timingEasyCheckbox">
                        <span class="ios-toggle-slider"></span>
                    </span>
                </label>
            </div>
            <button id="start-btn" onclick="readyBtn()">やりますねぇ‼️</button>
        </div>
    </div>
    <div id="score-ui"><span id="score-ui-val">0</span></div>
    <div id="GameTimeLayer"></div>
    <div id="gameBody"></div>
    <div id="GameScoreLayer">
        <h2 id="GameScoreLayer-text"></h2>
        <div class="score-item" id="GameScoreLayer-CPS">
            <div class="label">CPS</div>
            <div class="value" id="cps">0.0</div>
        </div>
        <div class="score-item" id="GameScoreLayer-score">
            <div class="label">スコア</div>
            <div class="value" id="score-result">0</div>
        </div>
        <div class="score-item" id="GameScoreLayer-bast">
            <div class="label">BEST</div>
            <div class="value" id="best">0</div>
        </div>
        <div>
            <button onclick="replayBtn()">もう一度</button>
            <button onclick="location.reload()">タイトル</button>
        </div>
    </div>
    <div id="customImageFull">
        <div id="customImageBg"></div>
        <img src="114514.jpg" alt="114514">
    </div>


<div id="pwaNotice" style="display:none;">
  <div class="pwa-notice-inner">
    <img src="iimage.png" alt="アイコン" class="pwa-icon">
    <span><b>ホーム画面に追加しよう。</b><br>iOS・macOSは共有から追加。</span>
    <button class="pwa-close-btn" aria-label="閉じる">&times;</button>
  </div>
</div>
    <script>
    // =============== 表示の瞬間ブラックアウト完全排除 ===============
    document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.add('ready');
        setTimeout(init, 1); // 1msでも即時起動
    });

    // 効果音リスト・変数
    const soundList = [
        { key: 'cc',    name: '標準',    file: 'cc.mp3'     },
        { key: '19',    name: '絶頂',    file: '19.mp3'     },
        { key: 'ka',    name: 'イク',    file: 'ka.mp3'     },
        { key: 'key',   name: '海外獣',  file: 'key.mp3'    },
        { key: 'mac',   name: 'フッ',    file: 'mac.mp3'    },
        { key: 'wrong', name: '獣',      file: 'wrong.mp3'  },
    ];
    let currentSoundKey = 'cc';
    let soundErr, soundEnd;
    let colNum = 3;
    let timingEasy = false; // チェックボックス状態

    let blockSize, GameLayer = [], GameLayerBG, touchArea = [], GameTimeLayer,
        _gameBBList = [], _gameBBListIndex = 0, _gameOver = false, _gameStart = false,
        _gameSettingNum = 20, _gameTime, _gameTimeNum, _gameScore, _date1, deviationTime,
        _gameStartTime, _gameStartDatetime, mode = 1, soundMode = 'on';

    const _ttreg = / t{1,2}(\d+)/;
    const _clearttClsReg = / t{1,2}\d+| bad| empty-cell/g;

    function initSoundSelect() {
        const sel = document.getElementById('soundSelect');
        sel.innerHTML = '';
        soundList.forEach((s) => {
            const opt = document.createElement('option');
            opt.value = s.key;
            opt.innerText = s.name;
            sel.appendChild(opt);
        });
        sel.value = currentSoundKey;
        updateSoundCheck();
        sel.onchange = function() {
            currentSoundKey = sel.value;
            updateSoundCheck();
            playSelectedSound();
        };
    }
    function updateSoundCheck() {
        const sel = document.getElementById('soundSelect');
        document.getElementById('soundCheck').textContent = '✔ ' + soundList.find(s => s.key === sel.value).name;
    }
    function playSelectedSound() {
        const s = soundList.find(s => s.key === currentSoundKey);
        if (s) {
            const audio = new Audio(s.file);
            audio.currentTime = 0;
            audio.play();
        }
    }
    function updateColNum() {
        let v = parseInt(document.getElementById('colInput').value);
        if (isNaN(v) || v < 2) v = 2;
        if (v > 10) v = 10;
        colNum = v;
        gameRestart();
    }

    function init() {
        initSoundSelect();
        document.getElementById('colInput').addEventListener('change', updateColNum);
        soundErr = new Audio("mac.wav");
        soundEnd = new Audio("collect.mp3");
        // iOSトグルのonchange
        const timingCb = document.getElementById('timingEasyCheckbox');
        timingCb.checked = false;
        timingEasy = false;
        timingCb.onchange = function() {
            timingEasy = timingCb.checked;
        };

        // レイヤー生成
        const gameBody = document.getElementById("gameBody");
        GameLayer = [];
        gameBody.innerHTML = '';
        const bgDiv = document.createElement("div");
        bgDiv.id = "GameLayerBG";
        gameBody.appendChild(bgDiv);
        GameLayerBG = bgDiv;
        for (let i = 1; i <= 2; i++) {
            const layerDiv = document.createElement("div");
            layerDiv.id = "GameLayer" + i;
            layerDiv.className = "GameLayer";
            for (let j = 0; j < 10; j++) {
                for (let k = 0; k < colNum; k++) {
                    const cellIndex = k + j * colNum;
                    const blockDiv = document.createElement("div");
                    blockDiv.id = layerDiv.id + "-" + cellIndex;
                    blockDiv.setAttribute("num", cellIndex);
                    blockDiv.className = "block" + (k ? " bl" : "");
                    layerDiv.appendChild(blockDiv);
                }
            }
            GameLayerBG.appendChild(layerDiv);
            GameLayer.push(layerDiv);
        }
        GameLayer[0].childrenList = Array.from(GameLayer[0].children);
        GameLayer[1].childrenList = Array.from(GameLayer[1].children);
        GameTimeLayer = document.getElementById("GameTimeLayer");
        GameLayerBG.onclick = function(e) {
            if (_gameOver) return false;
            let y = e.clientY;
            if (y > touchArea[0] || y < touchArea[1]) return;
            if (!e.target.classList.contains("block")) {
                return gameFail();
            }
        };
        gameRestart();
        window.addEventListener("resize", handleResize, false);
        setTimeout(refreshSize, 1);
    }

    function handleResize() { refreshSize(); }

    function gameFail() {
        if (_gameOver) return;
        _gameOver = true;
        showCustomImageFull();
        playMacOnce();
        updatePanel();
    }
   function playMacOnce() {
    if (soundErr) {
        soundErr.currentTime = 0;
        soundErr.play();
        soundErr.onended = function() {
            closeCustomImageFull();
            showGameScoreAfterCustom();
            soundErr.onended = null;
        };
    } else {
        closeCustomImageFull();
        showGameScoreAfterCustom();
    }
}


    function showGameScoreAfterCustom() {
        clearInterval(_gameTime);
        const cps = getCPS();
        updatePanel();
        setTimeout(() => { showGameScoreLayer(cps); }, 200);
    }
    function gameRestart() {
        _gameBBList = [];
        _gameBBListIndex = 0;
        _gameScore = 0;
        _gameOver = false;
        _gameStart = false;
        _gameTimeNum = _gameSettingNum;
        _gameStartTime = 0;
        closeCustomImageFull();
        countBlockSize();
        refreshGameLayer(GameLayer[0], false);
        refreshGameLayer(GameLayer[1], true, 1.5);
        updatePanel();
    }
    function countBlockSize() {
        const body = document.getElementById("gameBody");
        blockSize = body.offsetWidth / colNum;
        body.style.height = window.innerHeight + "px";
        GameLayerBG.style.height = window.innerHeight + "px";
        touchArea[0] = window.innerHeight;
        touchArea[1] = window.innerHeight - blockSize * 3;
    }
    function refreshGameLayer(box, loop, offset) {
        let i = Math.floor(Math.random() * 1000) % colNum + (loop ? 0 : colNum);
        for (let j = 0; j < box.children.length; j++) {
            const r = box.children[j];
            const rstyle = r.style;
            rstyle.left   = (j % colNum) * blockSize + "px";
            rstyle.bottom = Math.floor(j / colNum) * blockSize + "px";
            rstyle.top = "";
            rstyle.width  = blockSize + "px";
            rstyle.height = blockSize + "px";
            r.className = r.className.replace(_clearttClsReg, "");
            if (i === j) {
                const colorIndex = (Math.floor(Math.random() * 1000) % 5) + 1;
                r.className += " t" + colorIndex;
                r.notEmpty = true;
                _gameBBList.push({ cell: i % colNum, id: r.id });
                i = (Math.floor(j / colNum) + 1) * colNum + (Math.floor(Math.random() * 1000) % colNum);
            } else {
                r.className += " empty-cell";
                r.notEmpty = false;
            }
            r.onclick = function(e) {
                if (_gameOver) return;
                if (r.className.match(/tt\d/)) return;
                if (r.className.match(/t\d/)) {
                    if (!_gameStart) gameStart();
                    if (soundMode === "on") {
                        const sound = new Audio(soundList.find(s => s.key === currentSoundKey).file);
                        sound.currentTime = 0; sound.play();
                    }
                    // タイミングを掴みやすくON時
                    if (timingEasy) {
                        r.className = r.className.replace(_ttreg, " tt$1");
                        r.style.transition = "";
                        r.style.transform = "";
                        r.style.opacity = "";
                        r.style.zIndex = "";
                        r.style.pointerEvents = "";
                        _gameBBListIndex++;
                        _gameScore++;
                        updatePanel();
                        gameLayerMoveNextRow(1.5);
                        return;
                    }
                    // 通常アニメ
                    r.style.transition = "transform 0.4s cubic-bezier(.5,1.7,.5,1),opacity 0.4s cubic-bezier(.5,1.7,.5,1)";
                    r.style.zIndex = 11;
                    r.style.transform = "scale(1.45)";
                    r.style.opacity = 0;
                    r.style.pointerEvents = "none";
                    setTimeout(() => {
                        r.className = r.className.replace(_ttreg, " tt$1");
                        r.style.transition = "";
                        r.style.transform = "";
                        r.style.opacity = "";
                        r.style.zIndex = "";
                        r.style.pointerEvents = "";
                        if (!_gameOver) {
                            _gameBBListIndex++;
                            _gameScore++;
                            updatePanel();
                            gameLayerMoveNextRow(1.5);
                        }
                    }, 210);
                    return;
                }
                gameFail();
            };
            r.ontouchstart = r.onclick;
        }
        if (loop) {
            box.style.transitionDuration = "0ms";
            box.style.display = "none";
            box.y = - blockSize * (Math.floor(box.children.length / colNum) + (offset || 0));
            setTimeout(function() {
                box.style.transform = "translate3D(0," + box.y + "px,0)";
                setTimeout(function() { box.style.display = "block"; }, 100);
            }, 200);
        } else {
            box.y = 0;
            box.style.transform = "translate3D(0," + box.y + "px,0)";
        }
        box.style.transitionDuration = "150ms";
    }

    function gameLayerMoveNextRow(amount = 1.5) {
        for (let i = 0; i < GameLayer.length; i++) {
            const g = GameLayer[i];
            g.y += blockSize * amount;
            g.style.transition = "transform 0.24s cubic-bezier(.7,0,.2,1)";
            g.style.transform = "translate3D(0," + g.y + "px,0)";
            if (g.y > blockSize * (Math.floor(g.children.length / colNum))) {
                setTimeout(() => refreshGameLayer(g, true, amount), 250);
            }
        }
    }
    function readyBtn() {
        const card = document.getElementById("welcome-card");
        card.classList.add('hide-anim');
        setTimeout(() => {
            document.getElementById("welcome").style.display = "none";
            card.classList.remove('hide-anim');
            updatePanel();
        }, 500);
    }
    function timer() {
        _gameTimeNum--;
        _gameStartTime++;
        if (mode === 1 && _gameTimeNum <= 0) {
            GameTimeLayer.innerText = "TIME UP!";
            gameOver();
            GameLayerBG.classList.add("flash");
            if (soundMode === "on") {
                soundEnd.currentTime = 0; soundEnd.play();
            }
        }
        updatePanel();
    }
    function setScoreDisplay(score) {
        const ui = document.getElementById("score-ui-val");
        const res = document.getElementById("score-result");
        if (ui) { ui.innerText = score; ui.textContent = score; }
        if (res) { res.innerText = score; res.textContent = score; }
        if (ui) { ui.style.display='none'; ui.offsetHeight; ui.style.display=''; }
        if (res) { res.style.display='none'; res.offsetHeight; res.style.display=''; }
    }
    function updatePanel() {
        if (!_gameOver && mode === 1) {
            GameTimeLayer.innerText = "" + Math.ceil(_gameTimeNum);
        }
        setScoreDisplay(_gameScore);
    }
    function getCPS() {
        const elapsed = (new Date().getTime() - _gameStartDatetime) / 1000;
        let cps = _gameScore / elapsed;
        if (isNaN(cps) || cps === Infinity || _gameStartTime < 2) cps = 0;
        return cps;
    }
    function showCustomImageFull() {
        document.getElementById('customImageFull').style.display = 'flex';
    }
    function closeCustomImageFull() {
        document.getElementById('customImageFull').style.display = 'none';
    }
    function gameStart() {
        _date1 = new Date();
        _gameStartDatetime = _date1.getTime();
        _gameStart = true;
        _gameTime = setInterval(timer, 1000);
    }
    function gameOver() {
        if (_gameOver) return;
        _gameOver = true;
        clearInterval(_gameTime);
        const cps = getCPS();
        updatePanel();
        setTimeout(() => {
            GameLayerBG.classList.remove("flash");
            showGameScoreLayer(cps);
        }, 500);
    }


    function showGameScoreLayer(cps) {
        // 必ず全てのスコアUIを正しく再表示
        const layer = document.getElementById("GameScoreLayer");
        let text = "";
        if (mode === 1) {
            const date2 = new Date();
            deviationTime = date2.getTime() - (_date1 ? _date1.getTime() : Date.now());
            if (deviationTime >= (_gameSettingNum + 3) * 1000) {
                text = "TIME OVER: +" + ((deviationTime/1000) - _gameSettingNum).toFixed(2) + "s";
            } else { text = "TIME UP!"; }
        }
        document.getElementById("GameScoreLayer-text").innerText = text;
        document.getElementById("cps").innerText = cps ? cps.toFixed(2) : "0.00";
        setScoreDisplay(_gameScore);
        // BESTスコア
        const bestVal = getBestScore(_gameScore);
        const bestElem = document.getElementById("best");
        if (bestElem) {
            bestElem.innerText = bestVal;
            bestElem.textContent = bestVal;
        }
      // body拡大
    document.body.classList.add("bg-blowup");

    // スコアレイヤー拡大表示
    layer.classList.remove("score-in"); // アニメリセット
    layer.style.display = "flex";
    setTimeout(() => {
        layer.classList.add("score-in"); // 0.22sで拡大
    }, 10);
}
    function getBestScore(score) {
        const keyName = "best-normal";
        const prev = getCookie(keyName) ? parseFloat(getCookie(keyName)) : 0;
        const best = Math.max(prev, score);
        setCookie(keyName, best.toFixed(2), 365);
        return best.toString();
    }
  function replayBtn() {
    const layer = document.getElementById("GameScoreLayer");
    layer.style.display = "none";
    // --- ここでbodyスケールを絶対に1に戻す ---
    document.body.classList.remove("bg-blowup");
    document.body.classList.remove("card-in");      // 念のため
    document.body.classList.remove("page-scaled");  // 念のため
    document.body.classList.add("page-scaled");     // scale(1)だけ残す

    _gameBBList = [];
    _gameBBListIndex = 0;
    _gameScore = 0;
    _gameOver = false;
    _gameStart = false;
    _gameTimeNum = _gameSettingNum;
    _gameStartTime = 0;
    closeCustomImageFull();
    GameTimeLayer.innerText = "";
    refreshSize();
    gameRestart();
}

    function refreshSize() {
        clearTimeout(refreshSize._timer);
        refreshSize._timer = setTimeout(() => {
            countBlockSize();
            for (let i = 0; i < GameLayer.length; i++) {
                const box = GameLayer[i];
                for (let j = 0; j < box.children.length; j++) {
                    const r = box.children[j];
                    const rstyle = r.style;
                    rstyle.left = (j % colNum) * blockSize + "px";
                    rstyle.bottom = Math.floor(j / colNum) * blockSize + "px";
                    rstyle.top = "";
                    rstyle.width = blockSize + "px";
                    rstyle.height = blockSize + "px";
                }
                box.style.transform = "translate3D(0," + box.y + "px,0)";
            }
        }, 1);
    }
    document.addEventListener("keydown", function(e) {
        const key = e.key.toLowerCase();
        let idx = 0;
        if      (key === "d") idx = 1;
        else if (key === "f") idx = 2;
        else if (key === "j") idx = 3;
        else if (key === "k") idx = 4;
        if (idx >= 1 && _gameStart) {
            clickByKey(idx);
        }
    });
    function clickByKey(index) {
        const p = _gameBBList[_gameBBListIndex];
        const numBase = parseInt(document.getElementById(p.id).getAttribute("num")) - p.cell;
        const targetNum = numBase + (index - 1);
        const targetId = p.id.substring(0, p.id.indexOf("-") + 1) + targetNum;
        document.getElementById(targetId).dispatchEvent(new MouseEvent('mousedown', {bubbles:true}));
    }
    function setCookie(name, value, days) {
        const date = new Date();
        date.setTime(date.getTime() + (days*24*60*60*1000));
        document.cookie = name + "=" + encodeURIComponent(value) + ";expires=" + date.toUTCString() + ";path=/";
    }
    function getCookie(name) {
        const re = new RegExp("(?:(?:^|.*;\\s*)" + name + "\\s*\\=\\s*([^;]*).*$)|^.*$");
        return decodeURIComponent(document.cookie.replace(re, "$1")) || null;
    }

    document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('ready');
    setTimeout(() => {
        document.body.classList.add('page-scaled');
        setTimeout(() => {
            document.body.classList.add('card-in');
            setTimeout(init, 100); // アニメ開始直後にinit
        }, 500);
    }, 10); // 10msディレイで全体ズーム開始
});


let customImageClickCount = 0;

function showCustomImageFull() {
    const el = document.getElementById('customImageFull');
    el.style.display = 'flex';
    customImageClickCount = 0;

    // イベントを一度解除してから再度付与（多重登録防止）
    el.onclick = null;
    el.onclick = function() {
        customImageClickCount++;
        if (customImageClickCount >= 2) {
            // 画像即消してスコア出す、音はそのまま
            el.style.display = 'none';
            showGameScoreAfterCustom(true);
        }
    }
}
function closeCustomImageFull() {
    const el = document.getElementById('customImageFull');
    el.style.display = 'none';
    el.onclick = null;
}

    </script>

<script>
// PWAインストール判定
function isPWA() {
  return (window.matchMedia('(display-mode: standalone)').matches)
    || (window.navigator.standalone === true);
}
// バナー表示
function showPwaBanner() {
  const banner = document.getElementById('pwaNotice');
  const noticeInner = banner.querySelector('.pwa-notice-inner');
  if (!banner) return;
  banner.style.display = "block";
  setTimeout(()=>banner.classList.add('show'), 20);

  // ×ボタン: scale+opacity同時トランジション0.6s
  const closeBtn = banner.querySelector('.pwa-close-btn');
  closeBtn.onclick = () => {
    if (noticeInner.classList.contains('shrink')) return;
    noticeInner.classList.add('shrink');
    setTimeout(()=>{
      banner.style.display = "none";
      noticeInner.classList.remove('shrink');
      banner.classList.remove('show');
    }, 600);
  };
}


// iOS/Androidホーム追加バナー表示（PWA外＆モバイルのみ）
window.addEventListener('DOMContentLoaded', ()=>{
  if(
    !isPWA() &&
    (window.innerWidth<=600 || /iPhone|Android.+Mobile|iPod|Windows Phone|webOS|BlackBerry/i.test(navigator.userAgent))
  ){
    showPwaBanner();
  }
});

// sw.js
self.addEventListener('fetch', function(e) {
  e.respondWith(caches.match(e.request).then(function(response) {
    return response || fetch(e.request);
  }));
});

</script>
</body>
</html>
